---
lab:
    title: 'VNet 对等互连和服务链'
    module: '模块 05 - 站点间连接'
---

# 实验室：VNet 对等互连和服务链
  
本次练习中的所有任务都是在 Azure 门户执行的，练习 2 中的任务 3，练习 3 中的任务 1 和练习 3 中任务 2 除外，其中包括从与 Azure VM 的远程桌面会话中执行的步骤

实验室文件： 

-  **Labfiles\\Module_05\VNet_Peering_and_Service_Chaining\\az-100-04_01_azuredeploy.json**

-  **Labfiles\\Module_05\VNet_Peering_and_Service_Chaining\\az-100-04_02_azuredeploy.json**

-  **Labfiles\\Module_05\VNet_Peering_and_Service_Chaining\\az-100-04_azuredeploy.parameters.json**

### 场景
  
Adatum Corporation 希望在其 Azure 订阅中实现 Azure 虚拟网络之间的服务链。 


### 目标
  
完成本实验室后，你将能够：

- 使用 Azure 资源管理器模板创建 Azure 虚拟网络和部署 Azure VM。

- 配置 VNet 对等互连

- 实现自定义路由

- 验证服务链


### 练习 0：准备 Azure 环境
  
本次练习的主要任务如下：

1. 使用 Azure 资源管理器模板创建第一个托管两台 Azure VM 的虚拟网络

1. 使用 Azure 资源管理器模板在托管单个 Azure VM 的同一区域中创建第二个虚拟网络

#### 任务 1：使用 Azure 资源管理器模板创建第一个托管两台 Azure VM 的虚拟网络

1. 从实验室虚拟机启动 Microsoft Edge，浏览到 Azure 门户 [**http://portal.azure.com**](http://portal.azure.com)，然后使用 Microsoft 帐户登录，该帐户具有要在本实验室中使用的 Azure 订阅的所有者角色。

1. 在 Azure 门户中，导航到 **创建资源** 边栏选项卡。

1. 在 **创建资源** 边栏选项卡中，在 Azure 市场中搜索 **模板部署**。

1. 使用搜索结果列表导航到 **模板部署(使用自定义模板部署)** 边栏选项卡，然后单击 **创建**。

1. 在 **自定义部署** 边栏选项卡中，单击 **在编辑器中生成自己的模板** 链接。如果未看到此链接，请改为单击 **编辑模板**。

1. 在 **编辑模板** 边栏选项卡中，加载模板文件 Labfiles **\\Module_05\VNet_Peering_and_Service_Chaining\\az-100-04_01_azuredeploy.json**。 

   > **注意**：请查看模板的内容，并注意其定义了托管 Windows Server 2016 Datacenter 的 Azure VM 的部署。

1. 请保存模板并返回 **自定义部署** 边栏选项卡。 

1. 从 **自定义部署** 边栏选项卡中，导航到 **编辑参数** 边栏选项卡。

1. 在 **编辑参数** 边栏选项卡中，加载参数文件 **Labfiles\\Module_05\VNet_Peering_and_Service_Chaining\\az-100-04_azuredeploy.parameters.json**。 

1. 保存参数并返回到 **自定义部署** 边栏选项卡。 

1. 在 **自定义部署** 边栏选项卡中，使用以下设置启动模板部署：

    - 订阅：用于本实验室的订阅名称

    - 资源组：新资源组 **az1000401-RG** 的名称

    - 位置：最靠近实验室位置的 Azure 区域的名称以及可以在其中预配 Azure VM 的位置

    - VM 大小： **Standard_DS2_v2**

    - Vm1Name： **az1000401-vm1**

    - Vm2Name： **az1000401-vm2**

    - 管理员用户名： **Student**

    - 管理员密码： **Pa55w.rd1234**

    - 虚拟网络名称： **az1000401-vnet1**

   > **注意**： 若要标识可以预配 Azure VM 的 Azure 区域，请参阅 [**https://azure.microsoft.com/zh-cn/regions/offers/**](https://azure.microsoft.com/zh-cn/regions/offers/)

   > **注意**： 不必等待部署完成，请继续进行下一项任务。在本实验室的第二个练习中，您将使用此部署中包含的网络和虚拟机。


#### 任务 2：使用 Azure 资源管理器模板在托管单个 Azure VM 的同一区域中创建第二个虚拟网络

1. 在 Azure 门户中，导航到 **创建资源** 边栏选项卡。

1. 在 **创建资源** 边栏选项卡中，搜索 Azure 市场的 **模板部署**。

1. 使用搜索结果列表并选择 **模板部署(使用自定义模板部署)** 结果，然后单击 **创建**。

1. 在 **自定义部署** 边栏选项卡中，单击 **在编辑器中生成自己的模板** 链接。如果未看到此链接，请改为单击 **编辑模板**。

1. 在 **编辑模板** 边栏选项卡中，加载模板文件 **Labfiles\\Module_05\VNet_Peering_and_Service_Chaining\\az-100-04_02_azuredeploy.json**。 

   > **注意**： 请查看模板的内容，并注意其定义了托管 Windows Server 2016 Datacenter 的 Azure VM 的部署。

1. 保存模板并返回 **自定义部署** 边栏选项卡。 

1. 从 **自定义部署** 边栏选项卡中，导航到 **编辑参数** 边栏选项卡。

1. 在 **编辑参数** 边栏选项卡中，加载参数文件 **Labfiles\\Module_05\\Mod04\\az-100-04_azuredeploy.parameters.json**。 

1. 保存参数并返回 **自定义部署** 边栏选项卡。 

1. 从 **自定义部署** 边栏选项卡，使用以下设置启动模板部署：

    - 订阅：用于本实验室的订阅名称

    - 资源组：新资源组 **az1000402-RG** 的名称

    - 位置：在上一个任务中选择的 Azure 区域名称

    - VM 大小： **Standard_DS2_v2**

    - VmName： **az1000402-VM3**

    - 管理员用户名： **Student**

    - 管理员密码： **Pa55w.rd1234**

    - 虚拟网络名称： **az1000402-vnet2**

   > **注意**： 不必等待部署完成，请继续进行下一项任务。在本实验室的第二个练习中，您将使用此部署中包含的网络和虚拟机。

> **结果**： 完成本练习后，你已使用 Azure 资源管理器模板创建了两个 Azure 虚拟网络并启动了三个 Azure VM 的部署。


### 练习 1：配置 VNet 对等互连 

本练习的主要任务如下：

1. 为第一个虚拟网络配置 VNet 对等互连

1. 为第二个虚拟网络配置 VNet 对等互连


#### 任务 1：为第一个虚拟网络配置 VNet 对等互连
  
1. 在 Azure 门户中，导航到 **az1000401-vnet1** 虚拟网络边栏选项卡。

1. 在 **az1000401-vnet1** 虚拟网络边栏选项卡中，显示其 **对等互连** 边栏选项卡。

1. 在 **az1000401-vnet1 - 对等互连** 边栏选项卡中，单击 **+ 添加** 并使用以下设置创建 VNet 对等互连：

    - 名称： **az1000401-vnet1-to-az1000402-vnet2**

    - 虚拟网络部署模型： **资源管理器**

    - 订阅：用于本实验室的 Azure 订阅名称

    - 虚拟网络： **az1000402-vnet2**

    - 从 az1000402-vnet2 到 az1000401-vnet1 的对等互连名称： **az1000402-vnet2-to-az1000401-vnet1**

    - 允许虚拟网络访问： **已启用**

    - 允许转发流量： **禁用**

    - 允许网关传输： **禁用**

> **注意**： 由于你拥有对两个虚拟网络的管理访问权限，因此门户在单个操作中配置两个方向（从 vnet1 到 vnet2；从 AND vnet2 到 vnet1）。在 CLI、PowerShell 或 REST API 中，这些任务必须独立执行。 


### 练习 2：实现自定义路由
  
本练习的主要任务如下：

1. 为 Azure VM 的网络接口启用 IP 转发

1. 配置用户定义的路由 

1. 在运行 Windows Server 2016 的 Azure VM 中配置路由


#### 任务 1：为 Azure VM 的网络接口启用 IP 转发
  
   > **注意**： 在开始此任务之前，请确保已完成在练习 0 中启动的模板部署。 

1. 在 Azure 门户中，导航到第二个 Azure VM **az1000401-vm2** 对应的边栏选项卡。

1. 在 **az1000401-vm2** 边栏选项卡中，显示其 **网络** 边栏选项卡。 

1. 在 **az1000401-vm2 - 网络连接** 边栏选项卡中，显示 Azure VM 的网络适配器 (**az1000401-nic2**) 对应的边栏选项卡。

1. 在 **az1000401-nic2** 边栏选项卡，显示其 **IP 配置** 边栏选项卡。

1. 在 **az1000401-nic2 - IP 配置** 中，将 IP 转发设置为 **启用**，然后单击 **保存**。

   > **注意**： Azure VM **az1000401-vm2** （你在此任务中配置的网络接口）将充当路由器，从而促进两个虚拟网络之间的服务链。


#### 任务 2：配置用户定义的路由 

1. 在 Azure 门户中，导航到 **创建资源** 边栏选项卡。

1. 在 **创建资源** 边栏选项卡中，在 Azure 市场中搜索 **路由表**。

1. 选择 **路由表**，然后单击 **创建**。

1. 在 **创建路由表** 边栏选项卡中，使用以下设置创建新的路由表：

    - 名称： **az1000402-rt1**

    - 订阅：用于本实验室的 Azure 订阅名称

    - 资源组： **az1000402-RG**

    - 位置：在其中创建虚拟网络的同一 Azure 区域
  
    - 虚拟网络网关路由传播： **禁用**

1. 在 Azure 门户中，导航到 **az1000402-rt1** 边栏选项卡。

1. 在 **az1000402-rt1** 边栏选项卡中，显示其 **路由** 边栏选项卡。 

1. 在 **az1000402-rt1 - 路由** 边栏选项卡中，在路由表中添加具有以下设置的路由： 

    - 路由名称： **custom-route-to-az1000401-vnet1**

    - 地址前缀： **10.104.0.0/16**

    - 下一个跃点类型： **虚拟设备**

    - 下一个跃点地址： **10.104.1.4**

   > **注意**： **10.104.1.4** 是网络接口 **az1000401-vm2** 的 IP 地址，提供两个虚拟网络之间的服务链。

1. 在 **az1000402-rt1** 边栏选项卡中，显示其 **子网** 边栏选项卡。 

1. 在 **az1000402-rt1 - 子网** 边栏选项卡中，将路由表 **az1000402-rt1** 与 **az1000402-vnet2** 的 **subnet0** 关联。


#### 任务 3：在运行 Windows Server 2016 的 Azure VM 中配置路由

1. 在 Azure 门户中，导航到 **az1000401-vm2** Azure VM 边栏选项卡。 

1. 在 **az1000401-vm2** 边栏选项卡的 **概述** 窗格中，生成 RDP 文件并将其用于连接 **az1000401-vm2**。

1. 出现提示时，通过指定以下凭据进行身份验证：

    - 用户名称： **Student**

    - 密码： **Pa55w.rd1234**

1. 在与 **az1000401-vm2** 的远程桌面会话中，**在服务器管理** 器中使用 **添加角色和功能向导** 添加具有 **路由** 角色服务和所有必需功能的 **远程访问** 服务器角色。 

   > **注意**： 如果在 **添加角色和功能向导** 的 **服务器角色** 页上选中 **远程访问** 复选框后，收到错误消息 **此计算机与目标服务器或 VHD 之间可能存在版本不匹配**，请清除该复选框，单击 **下一步**，然后单击 **上一步** 并再次选中 **远程访问** 复选框。

1. 在与服务器管理器的 **az1000401-vm2** 的远程桌面会话中，启动“路由和远程访问”控制台。 

1. 在 **路由和远程访问** 控制台中，运行 **路由和远程访问服务器安装向导**，使用 **自定义配置** 选项，启用 **LAN 路由**，然后启动“路由和远程访问 **服务**。

1. 在与 **az1000401-vm2** 的远程桌面会话中，启动 **具有高级安全性的 Windows 防火墙** 控制台，并为所有配置文件启用 **文件和打印机共享(回显请求 - ICMPv4-In)** 入站规则。

> **结果**：完成本练习后，你已在对等互连的 Azure 虚拟网络之间实现自定义路由。 


### 练习 3：验证服务链

本练习的主要任务如下：

1. 在目标 Azure VM 上配置具有高级安全性的 Windows 防火墙

1. 测试对等互连虚拟网络之间的服务链


#### 任务 1：在目标 Azure VM 上配置具有高级安全性的 Windows 防火墙

1. 在 Azure 门户中，导航到 **az1000401-vm1** Azure VM 的边栏选项卡。 

1. 在 **az1000401-vm1** 边栏选项卡的 **概述** 窗格中，生成 RDP 文件并将其用于连接 **az1000401-vm1**。

1. 出现提示时，通过指定以下凭据进行身份验证：

    - 用户名称： **Student**

    - 密码： **Pa55w.rd1234**

1. 在与 **az1000401-vm1** 的远程桌面会话中，打开 **具有高级安全性的 Windows 防火墙** 控制台，并为所有配置文件启用 **文件和打印机共享(回显请求 - ICMPv4-In)**入站规则。


#### 任务 2：测试对等互连虚拟网络之间的服务链
  
1. 在 Azure 门户中，导航到 **az1000402-vm3** Azure VM 边栏选项卡。 

1. 在 **az1000402-vm3** 边栏选项卡的 **概述** 窗格中，生成 RDP 文件并将其用于连接 **az1000402-vm3**。

1. 出现提示时，通过指定以下凭据进行身份验证：

    - 用户名称： **Student**

    - 密码： **Pa55w.rd1234**

1. 通过远程桌面会话连接到 **az1-1000402-vm3** 后，启动 **Windows PowerShell**。

1. 在 **Windows PowerShell** 窗口中，运行以下命令：

   ```pwsh
   Test-NetConnection -ComputerName 10.104.0.4 -TraceRoute
   ```

   > **注意**： **10.104.0.4** 是第一个 Azure VM **az1000401-vm1** 的网络接口的 IP 地址

1. 验证测试是否成功，并注意连接已通过 **10.104.1.4** 路由

   > **注意**： 如果没有自定义路由，流量将直接在两个 Azure VM 之间流动。 
> **结果**： 完成本练习后，你已验证了对等互连的 Azure 虚拟网络之间的服务链。

## 练习 4：删除实验室资源

#### 任务 1：打开 Cloud Shell

1. 在门户顶部，单击 Cloud Shell 图标，打开 **Cloud Shell** 窗格。

1. 在 Cloud Shell 界面中，选择 **Bash**。

1. 在 **Cloud Shell** 命令提示符处，键入以下命令并按 **Enter**，列出在本实验室中创建的所有资源组：

   ```sh
   az group list --query "[?starts_with(name,'az1000')].name" --output tsv
   ```

1. 验证输出中是否仅包含在本实验室中创建的资源组。这些组将在下一个任务中删除。

#### 任务 2：删除资源组

1. 在 **Cloud Shell** 命令提示符处，键入以下命令并按 **Enter**，删除在本实验室中创建的资源组

   ```sh
   az group list --query "[?starts_with(name,'az1000')].name" --output tsv | xargs -L1 bash -c 'az group delete --name $0 --no-wait --yes'
   ```

1. 关闭门户底部的 **Cloud Shell** 提示。

> **结果**： 在本练习中，你删除了本实验室中使用的资源。
