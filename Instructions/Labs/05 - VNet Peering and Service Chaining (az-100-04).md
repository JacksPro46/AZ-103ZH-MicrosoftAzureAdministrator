---
lab:
    title: 'VNet 对等互连和服务链'
    module: '模块 05 - 站点间连接'
---

# 实验：VNet 对等互连和服务链接
  
本练习中的所有任务都从 Azure 门户执行，但练习 2 任务 3、练习 3 任务 1 和练习 3 任务 2 除外，这些任务包含从远程桌面会话执行到 Azure VM 的步骤

实验文件： 

-  **Labfiles\\Module_05\VNet_Peering_and_Service_Chaining\\az-100-04_01_azuredeploy.json**

-  **Labfiles\\Module_05\VNet_Peering_and_Service_Chaining\\az-100-04_02_azuredeploy.json**

-  **Labfiles\\Module_05\VNet_Peering_and_Service_Chaining\\az-100-04_azuredeploy.parameters.json**

### 场景
  
Adatum Corporation 希望在 Azure 订阅中实现 Azure 虚拟网络之间的服务链接。 


### 目标
  
完成本实验室后，你将能够：

- 使用 Azure 资源管理器模板创建 Azure 虚拟网络并部署 Azure VM。

- 配置 VNet 对等互连。

- 实现自定义路由

- 验证服务链接


### 练习 0：准备 Azure 环境
  
本练习的主要任务如下：

1. 使用 Azure 资源管理器模板创建托管两个 Azure VM 的第一个虚拟网络

1. 使用 Azure 资源管理器模板在同一区域中创建托管单个 Azure VM 的第二个虚拟网络

#### 任务 1：使用 Azure 资源管理器模板创建托管两个 Azure VM 的第一个虚拟网络

1. 从实验虚拟机启动 Microsoft Edge，浏览到 Azure 门户 ([**http://portal.azure.com**](http://portal.azure.com))，并使用在要用于本实验的 Azure 订阅中具有“所有者”角色的 Microsoft 帐户登录。

1. 在 Azure 门户中，导航到**“创建资源”**边栏选项卡。

1. 从 **创建资源** 边栏选项卡，在 Azure Marketplace 搜索 **模板部署**。

1. 使用搜索结果列表导航到**“模板部署(使用自定义模板部署)”**边栏选项卡，然后单击**“创建”**。

1. 在**“自定义部署”**边栏选项卡中，单击**“在编辑器中生成自己的模板”**链接。如果未看到此链接，请改为单击**“编辑模板”**。

1. 在**“编辑模板”**边栏选项卡中，加载模板文件 **Labfiles\\Module_05\VNet_Peering_and_Service_Chaining\\az-100-04_01_azuredeploy.json**。

   > **备注**：查看模板的内容，并注意其定义了托管 Windows Server 2016 Datacenter 的 Azure VM 的部署。

1. 保存模板并返回到**自定义部署**边栏选项卡。 

1. 从**自定义部署**边栏选项卡，导航到**编辑参数**边栏选项卡。

1. 在**编辑参数**边栏选项卡中，加载参数文件 **Labfiles\\Module_05\\VNet_Peering_and_Service_Chaining\\az-100-04_azuredeploy.parameters.json**。

1. 保存参数并返回到**自定义部署**边栏选项卡。 

1. 从**自定义部署**边栏选项卡，使用以下设置初始化模板部署：

    - 订阅：你在此实验室中使用的订阅的名称

    - 资源组：新资源组 **az1000401-RG** 的名称

    - 位置：最靠近实验室位置、可在其中预配 Azure VM 的 Azure 区域的名称

    - Vm 大小：根据讲师的建议，使用**Standard_DS1_v2**或**Standard_DS2_v2**

    - Vm1Name: **az1000401-vm1**

    - Vm2Name: **az1000401-vm2**

    - 管理员用户名：**学生**

    - 管理员密码：**Pa55w.rd1234**

    - 虚拟网络名称：**az1000401-vnet1**

   > **备注**：要确认可以配置 Azure VM 的 Azure 区域，请参阅 [**https://azure.microsoft.com/zh-cn/regions/offers/**](https://azure.microsoft.com/zh-cn/regions/offers/)

   > **备注**：请勿等待部署完成，而是继续进行下一项任务。在本实验的第二个练习中，你将使用此部署中包含的网络和虚拟机。


#### 任务 2：使用 Azure 资源管理器模板在同一区域中创建托管单个 Azure VM 的第二个虚拟网络

1. 在 Azure 门户中，导航到**“创建资源”**边栏选项卡。

1. 从 **创建资源** 边栏选项卡，在 Azure Marketplace 搜索 **模板部署**。

1. 使用搜索结果列表并选择**“模板部署(使用自定义模板部署)”**结果，然后单击**“创建”**。

1. 在**“自定义部署”**边栏选项卡中，单击**“在编辑器中生成自己的模板”**链接。如果未看到此链接，请改为单击**“编辑模板”**。

1. 在**“编辑模板”**边栏选项卡中，加载模板文件 **Labfiles\\Module_05\VNet_Peering_and_Service_Chaining\\az-100-04_02_azuredeploy.json**。 

   > **备注**：查看模板的内容，并注意其定义了托管 Windows Server 2016 Datacenter 的 Azure VM 的部署。

1. 保存模板并返回到**自定义部署**边栏选项卡。 

1. 从**自定义部署**边栏选项卡，导航到**编辑参数**边栏选项卡。

1. 在**“编辑参数”**边栏选项卡中，加载参数文件 **Labfiles\\Module_05\VNet_Peering_and_Service_Chaining\\az-100-04_azuredeploy.parameters.json**。 

1. 保存参数并返回到**自定义部署**边栏选项卡。 

1. 从**自定义部署**边栏选项卡，使用以下设置初始化模板部署：

    - 订阅：你在此实验室中使用的订阅的名称

    - 资源组：新资源组 **az1000402-RG 的名称**

    - 位置：你在上一个任务中选择的 Azure 区域的名称

    - Vm 大小：根据讲师的建议，使用**Standard_DS1_v2**或**Standard_DS2_v2**

    - VmName: **az1000402-vm3**

    - 管理员用户名：**学生**

    - 管理员密码：**Pa55w.rd1234**

    - 虚拟网络名称： **az1000402-vnet2**

   > **注意**：无需等待第一台虚拟机部署完成即可继续进行下一个任务。在本实验的第二个练习中，你将使用此部署中包含的网络和虚拟机。

> **结果**：完成此练习后，你已使用 Azure 资源管理器模板创建了两个 Azure 虚拟网络并启动了三个 Azure VM 的部署。


### 练习 1：配置 VNet 对等互连 

本练习的主要任务如下：

1. 为第一个虚拟网络配置 VNet 对等互连

1. 为第二个虚拟网络配置 VNet 对等互连


#### 任务 1：为第一个虚拟网络配置 VNet 对等互连
  
1. 在 Azure 门户，导航到 **az1000401-vnet1** 虚拟网络边栏选项卡。

1. 从 **az1000401-vnet1** 虚拟网络边栏选项卡，显示其**“对等互连”**边栏选项卡。

1. 在**“az1000401-vnet1 - 对等互连”**边栏选项卡中，单击**“+ 添加”**并使用以下设置创建 VNet 对等互连：

    - 名称：**az1000401-vnet1-to-az1000402-vnet2**

    - 虚拟网络部署模型：**资源管理器**
    
    - 我知道我的资源 ID：保留为未选中状态

    - 订阅：要用于本实验的 Azure 订阅的名称。

    - 虚拟网络：**az1000402-vnet2**

    - 从 az1000402-vnet2 到 az1000401-vnet1 的对等互连名称：**az1000402-vnet2-to-az1000401-vnet1**

    - 允许从 az1000401-vnet1 到 az1000402-vnet2 的虚拟网络访问：**启用**

    - 允许从 az1000402-vnet2 到 az1000401-vnet1 的虚拟网络访问：**启用**

    - 允许从 az1000402-vnet2 到 az1000401-vnet1 的转发流量：**禁用**
    
    - 允许从 az1000401-vnet1 到 az1000402-vnet2 的转发流量：**禁用**
  
    - 允许网关传输：未选中

> **备注**：由于你拥有对两个虚拟网络的管理访问权限，因此门户在单个操作中配置两个方向（从 vnet1 到 vnet2；从 AND vnet2 到 vnet1）。在 CLI、PowerShell 或 REST API 中，这些任务必须独立执行。 


### 练习 2：实现自定义路由
  
本练习的主要任务如下：

1. 为 Azure VM 的网络接口启用 IP 转发

1. 配置用户定义的路由 

1. 在运行 Windows Server 2016 的 Azure VM 中配置路由


#### 任务 1：为 Azure VM 的网络接口启用 IP 转发
  
   > **备注**：在开始此任务之前，请确保已完成在练习 0 中开始的模板部署。 

1. 在 Azure 门户中，导航到第二个 Azure VM **az1000401-vm2** 的边栏选项卡。

1. 从**“az1000401-vm2”**边栏选项卡，显示其**“网络”**边栏选项卡。 

1. 从**“az1000401-vm2 - 网络”**边栏选项卡，显示 Azure VM 的网络适配器 (**az1000401-nic2**) 的边栏选项卡。

1. 从**“az1000401-nic2”**边栏选项卡，展示其**“IP 配置”**边栏选项卡。

1. 在**“az1000401-nic2 - IP 配置”**中，将 IP 转发设置为**“启用”**，然后单击**“保存”**。

   > **备注**：Azure VM **az1000401-vm2**（你在此任务中配置的网络接口）将充当路由器，从而促进两个虚拟网络之间的服务链接。


#### 任务 2：配置用户定义的路由 

1. 在 Azure 门户中，导航到**“创建资源”**边栏选项卡。

1. 从**“创建资源”**边栏选项卡，在 Azure 市场中搜索**“路由表”**。

1. 选择**“路由表”**，然后单击**“创建”**。

1. 在**“创建路由表”**边栏选项卡中，使用以下设置创建新的路由表：

    - 名称：**az1000402-rt1**

    - 订阅：要用于本实验的订阅的名称

    - 资源组：**az1000402-RG**

    - 位置：你在其中创建了虚拟网络的 Azure 区域
  
    - 虚拟网络网关路由传播：**禁用**

1. 在 Azure 门户中，导航到**“az1000402-rt1”**边栏选项卡。

1. 从**“az1000402-rt1”**边栏选项卡，显示其**“路由”**边栏选项卡。 

1. 从**“az1000402-rt1 - 路由”**边栏选项卡，使用以下设置向路由表中添加路由： 

    - 路由名称：**custom-route-to-az1000401-vnet1**

    - 地址前缀：**10.104.0.0/16**

    - 下一个跃点类型：**虚拟设备**

    - 下一个跃点地址：**10.104.1.4**

   > **备注**：**10.104.1.4** 是 **az1000401-vm2** 网络接口的 IP 地址，它将提供两个虚拟网络之间的服务链接。

1. 从 **az1000402-rt1** 边栏选项卡，显示其**“子网”**边栏选项卡。 

1. 在**“az1000402-rt1 - 子网”**边栏选项卡中，关联路由表 **az1000402-rt1** 和 **az1000402-vnet2** 的 **subnet0**。


#### 任务 3：在运行 Windows Server 2016 的 Azure VM 中配置路由

1. 在 Azure 门户中，导航到 **az1000401-vm2** Azure VM 的边栏选项卡。 

1. 从 **az1000401-vm2** 边栏选项卡的**“概述”**，生成 RDP 文件并使用它连接到 **az1000401-vm2**。

1. 出现提示时，通过指定以下凭据进行身份验证：

    - 用户名称：**学生**

    - 密码：**Pa55w.rd1234**

1. 在从**服务器管理器**到**az1000401-vm2**的远程桌面会话中，选择**管理**，使用**添加角色和功能向导** 
1. 单击**下一步**两次，确保选择了**az1000401-vm2**，然后单击**下一步**，选择**远程访问**服务器角色，然后单击**下一步**三次，选择 **路由**角色服务，选择**添加功能**和所有必需的功能。选择**下一步**三遍，然后单击**安装**。安装完成后，单击**关闭**。

   > **备注**：在**“添加角色和功能向导”**的**“服务器角色”**页面上选中**“远程访问”**复选框后，如果收到错误消息**“此计算机和目标服务器或 VHD 之间可能存在版本不匹配”**，请取消选中复选框，单击**“下一步”**，单击**“上一步”**然后再次选中**“远程访问”**复选框。

1. 在从服务器管理器到**az1000401-vm2**的远程桌面会话中，选择**工具**，启动**路由和远程访问**控制台。 

1. 在**路由和远程访问**控制台中，右键单击服务器名称，然后选择**配置并启用路由和远程访问**，选择**下一步**，使用**自定义配置**，然后选择**下一步**，启用**LAN 路由**，单击**下一步**，单击**完成**，最后单击**启动服务**。

1. 在与 **az1000401-vm2** 的远程桌面会话中，启动具有**高级安全性的 Windows 防火墙**控制台，并为所有配置文件启用**“文件和打印机共享(回显请求 - ICMPv4-In)”**入站规则。

> **结果**：完成此练习后，你已在对等互连的 Azure 虚拟网络之间实现自定义路由。 


### 练习 3：验证服务链

本练习的主要任务如下：

1. 在目标 Azure VM 上配置具有高级安全性的 Windows 防火墙

1. 测试对等虚拟网络之间的服务链接


#### 任务 1：在目标 Azure VM 上配置具有高级安全性的 Windows 防火墙

1. 在 Azure 门户中，导航到 **az1000401-vm1** Azure VM 的边栏选项卡。 

1. 从 **az1000401-vm1** 边栏选项卡的**“概述”**窗格，生成 RDP 文件并使用它连接到 **az1000401-vm1**。

1. 出现提示时，通过指定以下凭据进行身份验证：

    - 用户名称：**学生**

    - 密码：**Pa55w.rd1234**

1. 在与 **az1000401-vm1** 的远程桌面会话中，打开具有**高级安全性的 Windows 防火墙**控制台，并为所有配置文件启用**“文件和打印机共享(回应请求 - ICMPv4-In)”**入站规则。


#### 任务 2：测试对等虚拟网络之间的服务链接
  
1. 在 Azure 门户中，导航到 **az1000402-vm3** Azure VM 的边栏选项卡。 

1. 在 **az1000402-vm3** 边栏选项卡的**“概述”**窗格中，生成 RDP 文件并使用它连接到 **az1000402-vm3**。

1. 出现提示时，通过指定以下凭据进行身份验证：

    - 用户名称：**学生**

    - 密码：**Pa55w.rd1234**

1. 通过远程桌面会话连接到 **az1-1000402-vm3** 后，启动 **Windows PowerShell**。

1. 在 **Windows PowerShell** 窗口中，运行以下命令：

```pwsh
   Test-NetConnection -ComputerName 10.104.0.4 -TraceRoute
```

   > **备注**：**10.104.0.4** 是第一个 Azure VM **az1000401-vm1** 网络接口的 IP 地址

1. 验证测试成功，并注意连接通过 **10.104.1.4** 路由

   > **备注**：如果没有自定义路由，流量将直接在两个 Azure VM 之间流动。 
> **结果**：完成此练习后，你已在对等互连的 Azure 虚拟网络之间验证了服务链。

## 练习 4：移除实验室资源

#### 任务1：打开 Cloud Shell

1. 在门户顶部，单击**“Cloud Shell”**图标，打开 Cloud Shell 窗格。

1. 在 Cloud Shell 界面中，选择**“Bash”**。

1. 在 **Cloud Shell** 命令提示符处，键入以下命令并按 **Enter** 键列出你在本实验室中创建的所有资源组：

```sh
   az group list --query "[?starts_with(name,'az1000')].name" --output tsv
```

1. 验证输出中是否仅包含在本练习中创建的资源组。将在下一个任务中删除这些资源组。

#### 任务2：删除资源组

1. 在 **Cloud Shell** 命令提示符处，键入以下命令并按 **Enter** 键以删除你在本实验室中创建的资源组

```sh
   az group list --query "[?starts_with(name,'az1000')].name" --output tsv | xargs -L1 bash -c 'az group delete --name $0 --no-wait --yes'
```

1. 关闭门户底部的 **Cloud Shell** 提示。

> **结果**：在本练习中，将删除本实验室中使用的资源。
