---
lab:
    title: 'VNet 对等和服务链'
    module: '创建和管理虚拟机网络'
---

# 逻辑阵列模块：VNet 对等和服务链
  
本次练习中的所有任务都是从 Azure 门户执行的，但练习 2 任务 3，练习 3 任务 1 和练习 3 任务 2 除外，其中包括从远程桌面会话到 Azure VM 执行的步骤

逻辑阵列模块文件： 

-  **Labfiles\\AZ100\\Mod04\\az-100-04_01_azuredeploy.json**

-  **Labfiles\\AZ100\\Mod04\\az-100-04_02_azuredeploy.json**

-  **Labfiles\\AZ100\\Mod04\\az-100-04_azuredeploy.parameters.json**

### 方案
  
Adatum Corporation 希望在 Azure 订阅中实现 Azure 虚拟网络之间的服务链接。 


### 目标
  
完成本逻辑阵列模块后，您将能够：

- 使用 Azure 资源管理器模板创建 Azure 虚拟网络并部署 Azure VM。

- 配置 VNet 对等

- 实现自定义路由

- 验证服务链


### 练习 0：准备 Azure 环境
  
本次练习的主要任务如下：

1. 使用 Azure 资源管理器模板创建托管两个 Azure VM 的第一个虚拟网络

1. 使用 Azure 资源管理器模板在托管单个 Azure VM 的同一区域中创建第二个虚拟网络

#### 任务 1：使用 Azure 资源管理器模板创建托管两个 Azure VM 的第一个虚拟网络

1. 从逻辑阵列模块虚拟机启动 Microsoft Edge，浏览到 Azure 门户 [**http://portal.azure.com**](http://portal.azure.com) 并使用在您打算在本逻辑阵列模块中使用的 Azure 订阅中的具有所有者角色的 Microsoft 帐户登录。

1. 在 Azure 门户中，导航到 **创建资源** 边栏选项卡。

1. 从创建资源边栏选项卡中搜索 Azure Marketplace 中的 **模板部署**。

1. 使用搜索结果列表导航到 **部署自定义模板** 边栏选项卡。

1. 在 **自定义部署** 边栏选项卡，请选择在编辑器中构 **建自己的模板**。

1. 从 **编辑模板** 边栏选项卡，加载模板文件 **Labfiles\\AZ100\\Mod04\\az-100-04_01_azuredeploy.json**。 

   > **注**：查看模板的内容，并注意其定义了托管 Windows Server 2016 Datacenter 的 Azure VM 的部署。

1. 保存模板并返回 **自定义部署** 边栏选项卡。 

1. 从 **自定义部署** 边栏选项卡，导航到 **编辑参数** 边栏选项卡。

1. 从 **编辑参数** 边栏选项卡，加载参数文件 **Labfiles\\AZ100\\Mod04\\az-100-04_azuredeploy.parameters.json**。 

1. 保存参数并返回 **自定义部署** 边栏选项卡。 

1. 从 **自定义部署** 边栏选项卡，使用以下设置启动模板部署：

    - 订阅：您希望用于本逻辑阵列模块的订阅名称

    - 资源组：新资源组 **az1000401-RG** 的名称

    - 位置：最靠近逻辑阵列模块位置的 Azure 区域的名称以及可以在其中配置 Azure VM 的位置

    - Vm 大小： **Standard_DS1_v2**

    - Vm1 名称： **az1000401-vm1**

    - Vm2 名称： **az1000401-vm2**

    - 管理员用户名： **学生**

    - 管理员密码： **Pa55w.rd1234**

    - 虚拟网络名称： **az1000401-vnet1**

   > **注**：要标识可以配置 Azure VM 的 Azure 区域，请参阅 [**https://azure.microsoft.com/zh-cn/regions/offers/**](https://azure.microsoft.com/zh-cn/regions/offers/)

   > **注**：请勿等待第一台虚拟机预配完成，请继续进行下一个任务在本次练习的第二个练习中，您将使用此部署中包含的网络和虚拟机。


#### 任务 2：使用 Azure 资源管理器模板在托管单个 Azure VM 的同一区域中创建第二个虚拟网络

1. 在 Azure 门户中，导航到 **创建资源** 边栏选项卡。

1. 从 **创建资源** 边栏选项卡中搜索 Azure Marketplace 中的 **模板部署**。

1. 使用搜索结果列表导航到 **部署自定义模板** 边栏选项卡。

1. 在 **自定义部署** 边栏选项卡，请选择在编辑器中构 **建自己的模板**。

1. 从 **编辑模板** 边栏选项卡，加载模板文件 **Labfiles\\AZ100\\Mod04\\az-100-04_02_azuredeploy.json** 

   > **注**：查看模板的内容，并注意其定义了托管 Windows Server 2016 Datacenter 的 Azure VM 的部署。

1. 保存模板并返回 **自定义部署** 边栏选项卡。 

1. 从 **自定义部署** 边栏选项卡，导航到 **编辑参数** 边栏选项卡。

1. 从 **编辑参数** 边栏选项卡，加载参数文件 **Labfiles\\AZ100\\Mod04\\az-100-04_azuredeploy.parameters.json**。 

1. 保存参数并返回 **自定义部署** 边栏选项卡。 

1. 从 **自定义部署** 边栏选项卡，使用以下设置启动模板部署：

    - 订阅：您希望用于本逻辑阵列模块的订阅名称

    - 资源组：新资源组的名称 **az1000402-RG**

    - 位置：您在上一个任务中选择的 Azure 区域的名称

    - Vm 大小： **Standard_DS1_v2**

    - 虚拟机名称： **az1000402-vm3**

    - 管理员用户名： **学生**

    - 管理员密码： **Pa55w.rd1234**

    - 虚拟网络名称： **az1000402-vnet2**

   > **注**： 请勿等待第一台虚拟机预配完成，请继续进行下一个任务在本次练习的第二个练习中，您将使用此部署中包含的网络和虚拟机。

> **结果**： 完成此练习后，您已使用 Azure 资源管理器模板创建了两个 Azure 虚拟网络并启动了三个 Azure VM 的部署。


### 练习 1：配置 VNet 对等 

本次练习的主要任务如下：

1. 为第一个虚拟网络配置 VNet 对等

1. 为第二个虚拟网络配置 VNet 对等


#### 任务 1：为第一个虚拟网络配置 VNet 对等
  
1. 在 Azure 门户，导航到 **az1000401-vnet1** 虚拟网络边栏选项卡。

1. 从 **az1000401-vnet1** 虚拟网络边栏选项卡，显示它 **Peerings** 边栏选项卡。

1. 从 **az1000401-vnet1 - Peerings** 边栏选项卡，使用以下设置创建 VNet 对等：

    - 名称： **az1000401-vnet1-to-az1000402-vnet2**

    - 虚拟网络部署模型：**资源管理器**

    - 订阅：您希望用于本逻辑阵列模块的 Azure 订阅名称。

    - 虚拟网络： **az1000402-vnet2**

    - 允许虚拟网络访问：**启用**

    - 允许转发流量：禁用

    - 允许网关中转：禁用

    - 使用远程网关：禁用


#### 任务 2：为第二个虚拟网络配置 VNet 对等
  
1. 在 Azure 门户，导航到 **az1000402-vnet2** 虚拟网络边栏选项卡。

1. 从 **az1000402-vnet2** 虚拟网络边栏选项卡，显示它 **Peerings** 边栏选项卡。

1. 从 **az1000402-vnet2 - Peerings** 边栏选项卡，使用以下设置创建 VNet 对等：

    - 名称： **az1000402-vnet2-to-az1000401-vnet1**

    - 虚拟网络部署模型：**资源管理器**

    - 订阅：您希望用于本逻辑阵列模块的 Azure 订阅名称。

    - 虚拟网络： **az1000401-vnet1**

    - 允许虚拟网络访问： **启用**

    - 允许转发流量：禁用

    - 允许网关中转：禁用

    - 使用远程网关：禁用

> **结果**：完成本次练习后，您已在两个虚拟网络之间配置了虚拟网络对等。


### 练习 2：实现自定义路由
  
本次练习的主要任务如下：

1. 为 Azure VM 的网络接口启用 IP 转发

1. 配置用户定义的路由 

1. 在运行 Windows Server 2016 的 Azure VM 中配置路由


#### 任务 1：为 Azure VM 的网络接口启用 IP 转发
  
   > **注**： 在开始此任务之前，请确保您在练习 0 中开始的模板部署已完成。 

1. 在 Azure 门户中，导航到第二个 Azure VM 的边栏选项卡 **az1000401-vm2**。

1. 从 **az1000401-vm2** 边栏选项卡，展示它 **联网** 边栏选项卡。 

1. 从 **az1000401-vm2 - 网络** 边栏选项卡，显示 Azure VM 的网络适配器（**az1000401-nic2**）的边栏选项卡。

1. 从 **az1000401-nic2** 边栏选项卡，展示它 **IP 配置** 边栏选项卡。

1. 从 **az1000401-nic2 - IP 配置** 边栏选项卡，启用 **IP 转发**。

   > **注**：Azure VM **az1000401-vm2** （您在此任务中配置的网络接口）将充当路由器，从而促进两个虚拟网络之间的服务链接。


#### 任务 2：配置用户定义的路由 

1. 在 Azure 门户中，导航到 **创建资源** 边栏选项卡。

1. 从 **创建资源** 边栏选项看，在 Azure Marketplace 搜索 **路线表**。

1. 使用搜索结果列表导航到 **创建路由表** 边栏选项卡。

1. 在 **创建路由表** 边栏选项卡中，使用以下设置创建新的路由表：

    - 名称： **az1000402-rt1**

    - 订阅：您希望用于本逻辑阵列模块的订阅名称

    - 资源组： **az1000402-RG**

    - 位置：您在其中创建虚拟网络的 Azure 区域
  
    - BGP 路由传播： **禁用**

1. 在 Azure 门户中，导航到 **az1000402-rt1** 边栏选项卡。

1. 从 **az1000402-rt1**，展示它 **路线** 边栏选项卡。 

1. 在 **az1000402-rt1 - 路线** 边栏选项卡，使用以下设置添加到路由表中的路由： 

    - 路线名称： **自定义路径 - az1000401-vnet1**

    - 地址前缀： **10.104.0.0/16**

    - 下一跳地址类型： **虚拟设备**

    - 下一跳地址： **10.104.1.4**

   > **注**： **10.104.1.4** 是网络接口的 IP 地址 **az1000401-vm2**，它将提供两个虚拟网络之间的服务链。

1. 在 **az1000402-rt1** 边栏选项卡中，展示它 **子网** 边栏选项卡。 

1. 在 **az1000402-rt1 - 子网** 边栏选项卡中，关联路由表 **az1000402-rt1** 同 **subnet0** 的 **az1000402-vnet2**。


#### 任务 3：在运行 Windows Server 2016 的 Azure VM 中配置路由

1. 在 Azure 门户中，导航到 **az1000401-VM2** Azure VM 边栏选项卡。 

1. 在 **概观** 窗格 **az1000401-VM2** 边栏选项卡自己拍美国，生成 RDP 文件并使用它连接 **az1000401-VM2**。

1. 出现提示时，通过指定以下凭据进行身份验证：

    - 用户名称： **学生**

    - 密码： **Pa55w.rd1234**

1. 在与 **服务器管理器** 的 **az1000401-vm2** 的远程桌面会话中，使用 **添加角色和功能向导** 添加具有 **路由** 角色服务和所有必需功能的 **远程访问** 服务器角色。。 

   > **注**：如果收到错误消息在 **添加角色和功能向导** 的 **服务器角色** 页面上选中 **远程访问** 复选框后，**此计算机与目标服务器或 VHD 之间可能存在版本不匹配**，请清除该复选框，单击 **下一步**，然后单击 **上一步**。 然后再次选择 **远程访问** 复选框。

1. 在与服务器管理器的 **az1000401-vm2** 的远程桌面会话中，启动 **路由和远程访问** 控制台。 

1. 在 **路由和远程访问** 控制台中，运行 **路由和远程访问服务器安装向导**，使用 **自定义配置** 选项，启用 **LAN 路由**，然后启动 **路由和远程访问** 服务。

1. 在与 **az1000401-vm2** 的远程桌面会话中，启动具有高级安全性的 **Windows 防火墙控制台**，并为所有个人资料启用 **文件和打印机共享（回显请求 -  ICMPv4-In）** 入站规则。

> **结果**：完成此练习后，您已在对等 Azure 虚拟网络之间实现自定义路由。 


### 练习 3：验证服务链

本次练习的主要任务如下：

1. 在目标 Azure VM 上配置具有高级安全性的 Windows 防火墙

1. 在对等虚拟网络之间进行测试服务链接


#### 任务 1：在目标 Azure VM 上配置具有高级安全性的 Windows 防火墙

1. 在 Azure 门户中，导航到 **az1000401-vm1** Azure VM 的边栏选项卡。 

1. 来自  **az1000401-vm1** 边栏选项卡的 **概观** 窗格，生成 RDP 文件并使用它连接到 **az1000401-vm1**。

1. 出现提示时，通过指定以下凭据进行身份验证：

    - 用户名称： **学生**

    - 密码： **Pa55w.rd1234**

1. 在远程桌面会话中 **az1000401-vm1**， 打开 **高级安全 Windows 防火墙** 控制台并且启用 **文件和打印机共享（回应请求 -  ICMPv4-In）** 所有个人资料的入站规则。


#### 任务 2：在对等虚拟网络之间进行测试服务链接
  
1. 在 Azure 门户中，导航到 **az1000402-VM3** Azure VM 边栏选项卡。 

1. 在 **概观** 窗格 **az1000402-VM3** 边栏选项卡中，生成 RDP 文件并使用它连接 **az1000402-VM3**。

1. 出现提示时，通过指定以下凭据进行身份验证：

    - 用户名称： **学生**

    - 密码： **Pa55w.rd1234**

1. 一旦您连接到 **az1-1000402-VM3** 通过远程桌面会话，启动 **Windows PowerShell**。

1. 在 **Windows PowerShell** 窗口中，运行以下命令：

   ```
   Test-NetConnection -ComputerName 10.104.0.4 -TraceRoute
   ```

   > **注**： **10.104.0.4** 是第一个 Azure VM **az1000401-VM1 的** 网络接口的 IP 地址 

1. 验证测试是否成功，并注意连接已被路由 **10.104.1.4**

   > **注**：如果没有自定义路由，流量将直接在两个 Azure VM 之间流动。 
> **结果**：完成此练习后，您已在对等 Azure 虚拟网络之间验证了服务链。
