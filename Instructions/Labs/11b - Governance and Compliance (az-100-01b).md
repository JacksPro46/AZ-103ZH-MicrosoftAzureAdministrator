---
lab:
    title: '实施 Azure 计划和资源锁的治理和合规'
    module: '管理 Azure 订阅和资源'
---

# 逻辑阵列模块：实施 Azure 计划和资源锁的治理和合规

本逻辑阵列模块中的所有任务都是从 Azure 门户执行的（包括 PowerShell Cloud Shell 会话）  

   > **注**：不使用 Cloud Shell 时，逻辑阵列模块虚拟机必须安装 Azure PowerShell 1.2.0 模块（或更新版本） [https://docs.microsoft.com/zh-cn/powershell/azure/install-az-ps?view=azps-1.2.0](https://docs.microsoft.com/zh-cn/powershell/azure/install-az-ps?view=azps-1.2.0)

逻辑阵列模块文件： 

-  **Allfiles/Labfiles/AZ-100.1/az-100-01b_azuredeploy.json**

-  **Allfiles/Labfiles/AZ-100.1/az-100-01b_azuredeploy.parameters.json**

### 方案
  
Adatum Corporation 希望使用 Azure Policy 和计划，以便在其 Azure 订阅中强制执行资源标记。如果环境兼容，Adatum 希望通过执行资源锁来防止意外更改。

### 目标
  
完成本逻辑阵列模块后，您将能够：

-  使用 Azure Policy 与计划来执行 Azure 标记

-  执行 Azure 资源锁


### 练习 1：使用 Azure Policy 与计划来执行 Azure 标记

本次练习的主要任务如下：

1. 使用 Azure 资源管理器模板配置 Azure 资源。

1. 实施评估资源标记合规的计划和策略。

1. 实施强制执行资源标记合规的策略。

1. 评估标记强制执行和标记合规。

1. 实施资源标记不合规的补救措施。

1. 评估补救任务对合规的影响。


#### 任务 1：使用 Azure 资源管理器模板配置 Azure 资源。

1. 从逻辑阵列模块虚拟机启动 Microsoft Edge，在 [**http://portal.azure.com**](http://portal.azure.com) 上浏览至 Azure 门户，并使用在您计划用于本次逻辑阵列模块的 Azure 订阅中具有“所有者”角色的 Microsoft 帐户进行登录。

1. 在 Azure 门户中，请导航到**新建**边栏选项卡。

1. 在**新建**边栏选项卡上，在Azure Marketplace 搜索 **模板部署**。

1. 请使用搜索结果列表，导航到 **自定义部署** 边栏选项卡。

1. 在 **自定义部署** 边栏选项卡上，请选择 **在编辑器中构建自己的模板**。

1. 在 **编辑模板** 边栏选项卡上，请加载模板文件 **az-100-01b_azuredeploy.json**。 

   > **注**：查看模板的内容，并注意其定义了托管 Windows Server 2016 Datacenter 的 Azure VM 的部署，包括其某些资源上的标记。

1. 请保存模板并返回**自定义部署**边栏选项卡。 

1. 从 **自定义部署** 边栏选项卡，导航到 **编辑参数** 边栏选项卡

1. 在 **编辑参数** 边栏选项卡上，请加载参数文件 **az-100-01b_azuredeploy.parameters.json**。 

1. 请保存参数并返回 **自定义部署** 边栏选项卡。 

1. 从 **自定义部署** 边栏选项卡，使用以下设置启动模板部署：

    - 订阅：在本次逻辑阵列模块中您所使用的订阅名称

    - 资源组：新资源组 **az1000101b-RG** 的名称

    - 位置：最靠近逻辑阵列模块位置的 Azure 区域的名称以及可以在其中配置 Azure VM 的位置

    - VM 大小： **Standard_DS1_v2**

    - Vm 名称： **az1000101b-VM1**

    - 管理员用户名： **学生**

    - 管理员密码： **Pa55w.rd1234**

    - 虚拟网络名称： **az1000101b-vnet1**

    - 环境名称： **lab**

   > **注**：如需识别您可以提供 Azure VM 的 Azure 区域，请查阅 [**https://azure.microsoft.com/en-us/regions/offers/**](https://azure.microsoft.com/en-us/regions/offers/)。

   > **注**：在继续执行下一个步骤前，请勿等待第一台虚拟机预配完成。
   
1. 在 Azure 门户中，请导航到 **标记** 边栏选项卡。

1. 在 **标记** 边栏中，显示 **环境** 标记设置为 value **lab** 的所有资源。请注意，仅前一项任务中部署的某些资源才会分配此标记。

   > **注**：此时，仅提供了一些资源，但是，您应看到至少有一些资源没有分配标记。


#### 任务 2：实施评估资源标记合规的策略和计划。

1. 在 Azure 门户中，请导航到 **策略** 边栏选项卡。

1. 从 **策略** 边栏选项卡，导航到 **策略-定义** 边栏选项卡。

1. 从 **策略定义** 边栏选项卡，显示 **强制执行标记及其值策略定义**。

1. 从 **强制标记及其值策略定义** 边栏选项卡，使用复制定义功能创建具有以下设置的新策略：

    - 定义位置：您在本逻辑阵列模块中使用的订阅的名称

    - 名称： **az10001b-审核标记及其值**

    - 描述： **审核所需的标记及其值。不适用于资源组。**

    - 类别：新类别 **逻辑阵列模块** 的名称

    - 策略规则：现有策略规则，其 **效果** 设置为 **audit**，因此策略定义包含以下内容：

   ```
   {
     "mode": "indexed",
     "policyRule": {
       "if": {
         "not": {
           "field": "[concat('tags[', parameters('tagName'), ']')]",
           "equals": "[parameters('tagValue')]"
         }
       },
       "then": {
         "effect": "audit"
       }
     },
     "parameters": {
       "tagName": {
         "type": "String",
         "metadata": {
           "displayName": "Tag Name",
           "description": "Name of the tag, such as 'environment'"
         }
       },
       "tagValue": {
         "type": "String",
         "metadata": {
           "displayName": "Tag Value",
           "description": "Value of the tag, such as 'production'"
         }
       }
     }
   }
   ```

1. 从 **策略-定义** 边栏选项卡，导航到 **新计划定义** 边栏选项卡。

1. 从 **新计划定义** 边栏选项卡，使用以下设置创建新的计划定义：

    - 定义位置：您在本逻辑阵列模块中使用的订阅的名称

    - 名称： **az10001b-Tagging initiative**

    - 描述： **标记策略的集合。**

    - 类别： **逻辑阵列模块**

    - 策略和参数： **az10001b-审核标记及其值**

        - 标记名称： **environment**

        - 标记值： **lab**

1. 导航到 **策略-分配** 边栏选项卡。

1. 从 **策略-分配** 边栏选项卡，导航到 **分配计划** 边栏选项卡，并使用以下设置创建新计划分配：

    - 范围：在本次逻辑阵列模块中您所使用的订阅名称

    - 排除项：无 

    - 计划定义： **az10001b-标记计划**

    - 分配名称： **az10001b-标记计划分配**

    - 描述： **az10001b-标记计划的分配**

    - 分配源：默认值

    - 创建托管身份： **未选中**

1. 导航到 **策略-合规** 边栏选项卡。请注意，**合规状态** 设置为 **未注册** 或 **未开始**。

   > **注**：总体而言，合规扫描开始大约需要 10 分钟。请勿等待合规扫描，而是继续执行下一个任务。您将在本次练习的后面部分查看合规状态。


#### 任务 3：实施强制执行资源标记合规的策略。

1. 导航到 **策略-定义** 边栏选项卡。

1. 从 **策略-定义** 边栏选项卡，导航到 **az10001b- 标记计划** 边栏选项卡。

1. 从 **az10001b-标记计划** 边栏选项卡，导航到它的 **编辑计划定义** 边栏选项卡。

1. 将名为 **强制执行标记的内置** 策略定义及其值添加到计划中，并将其参数设置为以下值：

    - 标记名称： **environment**

    - 标记值： **lab**

   > **注**：此时，您的计划包含两项策略。第一个评估合规状态，第二个在部署期间强制执行标记。 


#### 任务 4：评估标记强制执行和标记合规。

1. 在 Azure 门户中，请导航到 **新建** 边栏选项卡。

1. 在 **新建** 边栏选项卡上，在Azure Marketplace 搜索 **模板部署**。

1. 请使用搜索结果列表，导航到 **自定义部署** 边栏选项卡。

1. 在 **自定义部署** 边栏选项卡上，请选择 **在编辑器中构建自己的模板**。

1. 在 **编辑模板** 边栏选项卡上，请加载模板文件 **az-100-01b_azuredeploy.json**。 

   > **注**：这与您在本次练习的第一个任务中用于部署的模板相同。 

1. 请保存模板并返回 **自定义部署** 边栏选项卡。 

1. 从 **自定义部署** 边栏选项卡，导航到 **编辑参数** 边栏选项卡

1. 在 **编辑参数** 边栏选项卡上，请加载参数文件 **az-100-01b_azuredeploy.parameters.json**。 

1. 请保存参数并返回 **自定义部署** 边栏选项卡。 

1. 从 **自定义部署** 边栏选项卡，使用以下设置启动模板部署：

    - 订阅：在本次逻辑阵列模块中您所使用的订阅名称

    - 资源组：新资源组 **az1000102b-RG** 的名称

    - 位置：您在本次练习的第一个任务中选择的 Azure 区域的名称

    - VM 大小： **Standard_DS1_v2**

    - Vm 名称： **az1000102b-vm1**

    - 管理员用户名： **学生**

    - 管理员密码： **Pa55w.rd1234**

    - 虚拟网络名称： **az1000102b-vnet1**

    - 环境名称： **lab**

   > **注**：部署将失败。这是正常的。

1. 您将看到指示验证错误的消息。查看错误详细信息，指示策略强制执行标记不允许部署资源 **az1000102b-vnet1** **及其值被包括** 在内 **az10001b-标记计划分配中**。

1. 导航到 **策略-合规** 边栏选项卡。标识 **合规状态** 列中的条目。

1. 导航到 **az10001b-标记计划分配** 边栏选项卡，并查看合规状态摘要。

1. 显示资源合规列表，并记录哪些资源已被标识为不合规。 

   > **注**：您可能需要单击 **策略-合规** 边栏上的 **刷新** 按钮，以查看合规状态的更新。 


#### 任务 5：实施资源标记不合规的补救措施。

1. 在 Azure 门户中，导航到 **az10001b-标记计划** 边栏选项卡。

1. 从 **az10001b-标记计划** 边栏选项卡，导航到它的 **编辑计划定义** 边栏选项卡。

1. 将名为应用执行 **标记的内置策略定义及其默认值** 添加到计划中，并将其参数设置为以下值：

    - 标记名称： **environment**

    - 标记值： **lab**

1. 删除名为 **az10001b-审核标记的自定义策略定义及其从计划中获取的值**。

1. 从计划中删除名为 **强制执行标记** 的内置策略定义及其从计划中获取的值并保存更改。

   > **注**：此时，您的计划包含一个策略，可在部署新资源时自动修复标记不合规情况，并提供合规状态评估。

1. 在 Azure 门户中，在 Cloud Shell 中启动 PowerShell 会话。 

   > **注**：如果这是您第一次在当前 Azure 订阅中启动 Cloud Shell，则会要求您创建 Azure 文件共享以保留 Cloud Shell 文件。如果是，接受默认设置，这样会在自动生成的资源组中创建存储帐户。

1. 在 Cloud Shell 窗格中，运行以下命令。

   ```
   Get-AzResource-ResourceGroupName 'az1000101b-RG' | ForEach-Object {Set-AzResource -ResourceId $_.ResourceId -Tag @{environment="lab"} -Force }
   ```

   > **注**：这些命令将带有 value **lab** 的 **环境** 标记分配给资源组 **az1000101b-RG** 中的每个资源，覆盖任何已分配的标记。
   
   > **注**：等到命令成功完成。   

1. 在 Azure 门户中，请导航到 **标记** 边栏选项卡。

1. 在**标记**边栏中，显示 **环境** 标记设置为 value **lab** 的所有资源。验证是否列出了资源组 **az1000101b-RG** 中的所有资源。


#### 任务 6：评估补救任务对合规的影响。

1. 在 Azure 门户中，请导航到 **新建** 边栏选项卡。

1. 在 **新建** 边栏选项卡上，在Azure Marketplace 搜索 **模板部署**。

1. 请使用搜索结果列表，导航到 **自定义部署** 边栏选项卡。

1. 在 **自定义部署** 边栏选项卡上，请选择 **在编辑器中构建自己的模板**。

1. 在 **编辑模板** 边栏选项卡上，请加载模板文件 **az-100-01b_azuredeploy.json**。 

   > **注**：这与您在本次练习的第一个任务中用于部署的模板相同。 

1. 请保存模板并返回 **自定义部署** 边栏选项卡。 

1. 从 **自定义部署** 边栏选项卡，导航到 **编辑参数** 边栏选项卡

1. 在 **编辑参数** 边栏选项卡上，请加载参数文件 **az-100-01b_azuredeploy.parameters.json**。 

1. 请保存参数并返回 **自定义部署** 边栏选项卡。 

1. 从 **自定义部署** 边栏选项卡，使用以下设置启动模板部署：

    - 订阅：在本次逻辑阵列模块中您所使用的订阅名称

    - 资源组： **az1000102b-RG**

    - 位置：您在本次练习的第一个任务中选择的 Azure 区域的名称

    - VM 大小： **Standard_DS1_v2**

    - Vm 名称： **az1000102b-vm1**

    - 管理员用户名： **学生**

    - 管理员密码： **Pa55w.rd1234**

    - 虚拟网络名称： **az1000102b-vnet1**

    - 环境名称： **lab**

   > **注**：此次部署将成功。这是正常的。

   > **注**：在继续执行下一个步骤前，请勿等待第一台虚拟机预配完成。 

1. 在 Azure 门户中，请导航到 **“标记”** 边栏选项卡。

1. 在 **标记** 边栏中，显示 **环境** 标记设置为 value **lab** 的所有资源。请注意，部署到资源组 **az1000102b-RG** 的所有资源均具有自动分配的相同值的该标记。

   > **注**：此时，仅提供了一些资源，但是，您应看到所有资源均分配有标记。

1. 导航到 **策略-合规** 边栏选项卡。标识 **合规状态** 列中的条目。

1. 导航到 **az10001b-标记计划分配** 边栏选项卡。标识 **合规状态** 列中的条目。如果该列包含**未启动** 条目，请等待合规扫描运行。 

   > **注**：您可能需要等待最多 10 分钟，然后单击 **策略-合规** 边栏上的 **刷新** 按钮，查看合规状态的更新。 

   > **注**：不要等到状态列为合规，而是继续进行下一项练习。 

> **结果：** 完成本次练习后，您已实施评估、强制执行和修复资源标记合规的一项计划和策略。另外，您还评估了策略分配的效果。 


### 练习 2：执行 Azure 资源锁
  
本次练习的主要任务如下：

1. 创建资源组级锁，以防止意外更改

1. 验证资源组级锁的功能


#### 任务 1：创建资源组级锁，以防止意外更改

1. 在 Azure 门户中，导航到 **az1000101b-RG** 资源组边栏选项卡。

1. 从 **az1000101b-RG** 资源组边栏选项卡，显示 **az1000101b-RG-锁边** 栏选项卡。

1. 从 **az1000101b-RG-锁边** 栏选项卡，使用以下设置添加锁：

    - 锁名称： **az1000101b-roLock**

    - 锁类型： **Read-only**


#### 任务 2：验证资源组级锁的功能

1. 在 Azure 门户中，导航到 **az1000102b-VM1** 虚拟机边栏选项卡。

1. 从 **az1000102b-VM1** 虚拟机边栏选项卡，导航到 **az1000102b-vm1-标记** 边栏选项卡。

1. 尝试将 **环境** 标记的值设置为 **dev**。请注意，操作成功。 

1. 在 Azure 门户中，导航到 **az1000101b-vm1** 虚拟机边栏选项卡。

1. 从 **az1000101b-vm1** 虚拟机边栏选项卡，导航到 **az1000101b-vm1-标记** 边栏选项卡。

1. 尝试将 **环境** 标记的值设置为 **dev**。请注意，此时操作失败。生成的错误消息指示资源拒绝标记分配，而可能原因是资源锁。

1. 导航到 **az1000101b-RG-锁资** 源组中创建的存储帐户的边栏选项卡。 

1. 从存储帐户边栏选项卡，导航到其 **访问密钥** 边栏选项卡。请注意由此产生的错误消息，指出您无法访问数据层，因为资源或其父级资源上的读锁。

1. 在 Azure 门户中，导航到 **az1000101b-RG** 资源组边栏选项卡。

1. 从 **az1000101b-RG** 资源组边栏选项卡，导航到其 **标记** 边栏选项卡。

1. 从 **标记** 边栏选项卡，尝试将带 value **lab** 的 **环境** 标记分配给资源组，并记录错误消息。


> **结果**：完成此练习后，您已创建资源组级锁以防止意外更改并验证其功能。 
