---
lab:
    title: '治理与符合性'
    module: '模块 11 - 治理与符合性'
---

# 实验：实施 Azure 计划和资源锁的治理和合规

本实验室中的所有任务都从 Azure 门户执行（包括 PowerShell Cloud Shell 会话）  

   > **注**：不使用 Cloud Shell 时，实验室虚拟机必须安装 Azure PowerShell 1.2.0 模块（或更新版本） [https://docs.microsoft.com/zh-cn/powershell/azure/install-az-ps](https://docs.microsoft.com/zh-cn/powershell/azure/install-az-ps)

实验文件： 

-  **Labfiles\\Module_11\\Governance_and_Compliance\\AZ-100.1\\az-100-01b_azuredeploy.json**

-  **Labfiles\\Module_11\\Governance_and_Compliance\\az-100-01b_azuredeploy.parameters.json**

### 场景
  
Adatum 公司希望使用 Azure 政策和计划，以便在其 Azure 订阅中强制执行资源标记。如果环境符合，Adatum 希望通过执行资源锁来防止意外更改。

### 目标
  
完成本实验室后，你将能够：

-  使用 Azure 政策与计划来执行 Azure 标记

-  执行 Azure 资源锁


### 练习 1：通过使用 Azure 政策与计划来执行 Azure 标记

本次练习的主要任务如下：

1. 通过使用 Azure 资源管理器模板预配 Azure 资源。

1. 实施评估资源标记合规的计划和政策。

1. 实施强制执行资源标记合规的政策。

1. 评估标记强制执行和标记合规。

1. 实施资源标记不合规的补救。

1. 评估补救任务对合规的影响。


#### 任务 1：使用 Azure 资源管理器模板预配 Azure 资源。

1. 从实验室虚拟机启动 Microsoft Edge，在[**http://portal.azure.com**](http://portal.azure.com)上浏览至 Azure 门户，并使用在你计划用于本实验室块的 Azure 订阅中具有“所有者”角色的 Microsoft 帐户进行登录。

1. 在 Azure 门户中，导航到**创建资源**边栏选项卡。

1. 从 **创建资源** 边栏选项卡，在 Azure Marketplace 搜索 **模板部署**。

1. 使用搜索结果列表导航到**自定义部署**边栏选项卡。

1. 在 **自定义部署**边栏选项卡，选择**在编辑器中构建自己的模板**。

1. 在**编辑模板**边栏选项卡上，加载模板文件**az-100-01b_azuredeploy.json**。 

   > **注**：查看模板的内容，并注意其定义了托管 Windows Server 2016 Datacenter 的 Azure VM 的部署，包括其某些资源上的标记。

1. 请保存模板并返回**自定义部署**边栏选项卡。 

1. 从**自定义部署**边栏选项卡导航到**编辑参数**边栏选项卡。

1. 从**编辑参数**边栏选项卡，加载参数文件**az-100-01b_azuredeploy.parameters.json**。 

1. 请保存参数并返回**自定义部署**边栏选项卡。 

1. 从**自定义部署**边栏选项卡，使用以下设置初始化模板部署：

    - 订阅：在本实验室中你所使用的订阅名称

    - 资源组：新资源组**az1000101b-RG**的名称

    - 位置：最接近实验室位置的 Azure 区域的名称，在那里你可以配置 Azure VM

    - VM 大小：**Standard_DS1_v2**

    - Vm 名称：**az1000101b-vm1**

    - 管理员用户名：**学生**

    - 管理员密码：**Pa55w.rd1234**

    - 虚拟网络名称： **az1000101b-vnet1**

    - 环境名称：**实验室**

   > **注**：如需识别您可以配置 Azure VM 的 Azure 区域，请参阅 [**https://azure.microsoft.com/zh-cn/regions/offers/**](https://azure.microsoft.com/zh-cn/regions/offers/)

   > **注**：在继续执行下一个步骤前，请勿等待部署完成。
   
1. 在 Azure 门户中，导航到**标记**边栏选项卡。

1. 在**标记**边栏选项卡中，显示**环境**标记设置为值**实验室**的所有资源。请注意，仅前一项任务中部署的某些资源才会分配此标记。

   > **注**：此时，仅提供了一些资源，但是，你应看到至少有一些资源没有分配到标记。


#### 任务 2：实施评估资源标记合规的政策和计划。

1. 在 Azure 门户中，导航到**政策**边栏选项卡。

1. 从**策略**边栏选项卡，导航到**政策-定义**边栏选项卡。

1. 在**“策略定义”**边栏选项卡中，显示**“需要标记及其值”**策略定义。

1. 在**“需要标记及其值”**策略定义边栏选项卡中，使用复制定义功能创建具有以下设置的新策略：

    - 定义位置：你在本实验室中使用的订阅的名称

    - 名称：**az10001b-审核标记及其值**

    - 描述：**审核所需的标记及其值。不适用于资源组。**

    - 类别：新类别**实验室**的名称

    - 策略规则：在现有策略规则中，将**“效果”**从**“拒绝”**更改为**“审核”**，使策略定义包含以下内容：

```json
   {
     "mode": "indexed",
     "policyRule": {
       "if": {
         "not": {
           "field": "[concat('tags[', parameters('tagName'), ']')]",
           "equals": "[parameters('tagValue')]"
         }
       },
       "then": {
         "effect": "audit"
       }
     },
     "parameters": {
       "tagName": {
         "type": "String",
         "metadata": {
           "displayName": "Tag Name",
           "description": "Name of the tag, such as 'environment'"
         }
       },
       "tagValue": {
         "type": "String",
         "metadata": {
           "displayName": "Tag Value",
           "description": "Value of the tag, such as 'production'"
         }
       }
     }
   }
```

1. 从**政策-定义**边栏选项卡，导航到**新计划定义**边栏选项卡。

1. 从**新计划定义**边栏选项卡，使用以下设置创建新计划定义：

    - 定义位置：你在本实验室中使用的订阅的名称

    - 名称：**az10001b - Tagging initiative**

    - 描述：**标记政策的集合。**

    - 类别：**实验室**

    - 可用定义：搜索并选择 **az10001b - 审核标记及其值**

        - 标记名称：**环境**

        - 标记值：**实验室**

1. 导航到**政策-分配**边栏选项卡。

1. 从**政策-分配**边栏选项卡，导航到**分配计划**边栏选项卡，并使用以下设置创建新计划分配：

    - 范围：在本实验室中你所使用的订阅的名称

    - 除外条款：无 

    - 计划定义：**az10001b-标记计划**

    - 分配名称：**az10001b-标记计划分配**

    - 描述：**az10001b-标记计划的分配**

    - 分配源：默认值

    - 创建托管标识：**未选中**

1. 导航到**政策-合规**边栏选项卡。请注意，**合规状态**设置为**未注册**或**未开始**。

   > **注**：总体而言，开始合规审查需要大约 10 分钟。请勿等待合规审查，而是继续执行下一个任务。你将在本练习的后面部分查看合规状态。


#### 任务 3：实施强制执行资源标记合规的政策。

1. 导航到**政策-定义**边栏选项卡。

1. 从**政策-定义**边栏选项卡，导航到**az10001b- 标记计划**边栏选项卡。

1. 从**az10001b-标记计划**边栏选项卡，导航到其**编辑计划定义**边栏选项卡。

1. 将名为**“需要标记及其值”**的内置策略定义添加到计划中，并将其参数设置为以下值：

    - 标记名称：**环境**

    - 标记值：**实验室**

   > **注**：此时，你的计划包含两项政策。第一个评估合规状态，第二个在部署期间强制执行标记。 


#### 任务 4：评估标记强制执行和标记合规。

1. 在 Azure 门户中，导航到 **创建资源** 边栏选项卡。

1. 在**新建**边栏选项卡，在 Azure 市场中搜索**模板部署**。

1. 使用搜索结果列表导航到**自定义部署**边栏选项卡。

1. 在 **自定义部署**边栏选项卡，选择**在编辑器中构建自己的模板**。

1. 在**编辑模板**边栏选项卡上，加载模板文件**az-100-01b_azuredeploy.json**。 

   > **注**：这与你在本次练习的第一个任务中用于部署的模板相同。 

1. 请保存模板并返回**自定义部署**边栏选项卡。 

1. 从**自定义部署**边栏选项卡导航到**编辑参数**边栏选项卡。

1. 从**编辑参数**边栏选项卡，加载参数文件**az-100-01b_azuredeploy.parameters.json**。 

1. 请保存参数并返回**自定义部署**边栏选项卡。 

1. 从**自定义部署**边栏选项卡，使用以下设置初始化模板部署：

    - 订阅：在本实验室中你所使用的订阅名称

    - 资源组：新资源组**az1000102b-RG**的名称

    - 位置：你在本练习的第一个任务中选择的 Azure 区域的名称

    - Vm 大小：**Standard_DS1_v2**

    - Vm名称：**az1000102b-vm1**

    - 管理员用户名：**学生**

    - 管理员密码：**Pa55w.rd1234**

    - 虚拟网络名称： **az1000102b-vnet1**

    - 环境名称：**实验室**

   > **注**：部署将失败。这是正常的。

1. 你将看到指示验证错误的消息。查看错误详细信息，该信息指示**“az10001b - 标记计划分配”**中包含的策略**“需要标记及其值”**不允许部署资源 **az1000102b-vnet1**。

1. 导航到**政策-合规**边栏选项卡。标识**合规状态**列中的条目。

1. 导航到**“az10001b - 标记计划分配”**边栏选项卡，查看符合性状态摘要。

1. 显示资源合规列表，并记录哪些资源已被标识为不合规。 

   > **注**：你可能需要单击**政策-合规**边栏选项卡上的**刷新**按钮，以查看合规状态的更新。 


#### 任务 5：实施资源标记不合规的补救措施。

1. 在 Azure 门户中，导航到**az10001b-标记计划**边栏选项卡。

1. 从**az10001b-标记计划**边栏选项卡，导航到其**编辑计划定义**边栏选项卡。

1. 将名为**“追加标记及其默认值”**的内置策略定义添加到计划中，并将其参数设置为以下值：

    - 标记名称：**环境**

    - 标记值：**实验室**

1. 从计划中删除名为**z10001b-审核标记及其值**的自定义政策定义。

1. 从计划中删除名为**“需要标记及其值”**的内置策略定义并保存所做的更改。

   > **备注**：此时，你的计划包含单个政策，可在部署新资源时自动修复标记不合规，并提供合规状态评估。

1. 从 Azure 门户，在 Cloud Shell 中启动 PowerShell 会话。 

   > **注**：如果这是您第一次在当前 Azure 订阅中启动 Cloud Shell，则会要求您创建 Azure 文件共享以保留 Cloud Shell 文件。如果是，接受默认设置，这样会在自动生成的资源组中创建存储帐户。

1. 在 Cloud Shell 窗格中，运行以下命令。

```pwsh
   Get-AzResource -ResourceGroupName 'az1000101b-RG' | ForEach-Object {Set-AzResource -ResourceId $_.ResourceId -Tag @{environment="lab"} -Force }
```

   > **备注**：这些命令将具有值**实验室**的**环境**标记分配给资源组**az1000101b-RG**中的每个资源，覆盖任何已分配的标记。
   
   > **注**：等到命令成功完成。   

1. 在 Azure 门户中，导航到**标记**边栏选项卡。

1. 在**标记**边栏选项卡中，显示**环境**标记设置为值**实验室**的所有资源。验证是否列出了资源组**az1000101b-RG**中的所有资源。


#### 任务 6：评估补救任务对合规的影响。

1. 在 Azure 门户中，导航到 **创建资源** 边栏选项卡。

1. 在**新建**边栏选项卡，在 Azure 市场中搜索**模板部署**。

1. 使用搜索结果列表导航到**自定义部署**边栏选项卡。

1. 在 **自定义部署**边栏选项卡，选择**在编辑器中构建自己的模板**。

1. 在**编辑模板**边栏选项卡上，加载模板文件**az-100-01b_azuredeploy.json**。 

   > **注**：这与你在本次练习的第一个任务中用于部署的模板相同。 

1. 请保存模板并返回**自定义部署**边栏选项卡。 

1. 从**自定义部署**边栏选项卡导航到**编辑参数**边栏选项卡。

1. 从**编辑参数**边栏选项卡，加载参数文件**az-100-01b_azuredeploy.parameters.json**。 

1. 请保存参数并返回**自定义部署**边栏选项卡。 

1. 从**自定义部署**边栏选项卡，使用以下设置初始化模板部署：

    - 订阅：在本实验室中你所使用的订阅名称

    - 资源组：**az1000102b-RG**

    - 位置：你在本次练习的第一个任务中选择的 Azure 区域的名称

    - Vm 大小：**Standard_DS1_v2**

    - Vm名称：**az1000102b-vm1**

    - 管理员用户名：**学生**

    - 管理员密码：**Pa55w.rd1234**

    - 虚拟网络名称： **az1000102b-vnet1**

    - 环境名称：**实验室**

   > **注**：此次部署将成功。这是正常的。

   > **注**：在继续执行下一个步骤前，请勿等待部署完成。 

1. 在 Azure 门户中，导航到**标记**边栏选项卡。

1. 在**标记**边栏选项卡中，显示**环境**标记设置为值**实验室**的所有资源。请注意，部署到资源组**az1000102b-RG**的所有资源均具有自动分配的相同值的该标记。

   > **注**：此时，仅提供了一些资源，但是，你应看到所有资源均分配有标记。

1. 导航到**政策-合规**边栏选项卡。标识**合规状态**列中的条目。

1. 导航到**az10001b-标记计划分配**边栏选项卡。标识**合规状态**列中的条目。如果该列包含**未启动**条目，请等待其合规审查运行。 

   > **注**：你可能需要等待最多 10 分钟，然后单击**政策-合规**边栏选项卡上的**刷新**按钮，查看合规状态的更新。 

   > **注**：请勿等到状态列为合规，而是继续进行下一项练习。 

> **结果**：完成本次练习后，你已实施评估、强制执行和修复资源标记合规的计划和政策。另外，你还评估了政策分配的效果。 


### 练习 2：执行 Azure 资源锁
  
本次练习的主要任务如下：

1. 创建资源组级锁，以防止意外更改

1. 验证资源组级锁的功能


#### 任务 1：创建资源组级锁，以防止意外更改

1. 在 Azure 门户中，导航到**az1000101b-RG**资源组边栏选项卡。

1. 从**az1000101b-RG**资源组边栏选项卡，显示**az1000101b-RG-锁**边栏选项卡。

1. 从**az1000101b-RG-锁**边栏选项卡，使用以下设置添加锁：

    - 锁名称：**az1000101b-roLock**

    - 锁类型：**只读**


#### 任务 2：验证资源组级锁的功能

1. 在 Azure 门户中，导航到**az1000102b-vm1**虚拟机边栏选项卡。

1. 从**az1000102b-vm1**虚拟机边栏选项卡，导航到**az1000102b-vm1-标记**边栏选项卡。

1. 尝试将**环境**标记的值设置为**dev**。请注意，操作成功。 

1. 在 Azure 门户中，导航到**az1000101b-vm1**虚拟机边栏选项卡。

1. 从**az1000101b-vm1**虚拟机边栏选项卡，导航到**az1000101b-vm1-标记**边栏选项卡。

1. 尝试将**环境**标记的值设置为**dev**。请注意，此时操作失败。生成的错误消息指示资源拒绝标记分配，而可能原因是资源锁。

1. 导航到**az1000101b-RG**资源组中创建的存储账户的边栏选项卡。 

1. 从存储账户边栏选项卡，导航到其**访问密钥**边栏选项卡。请注意由此产生的错误消息，指出你无法访问数据平面，因为资源或其父级资源上的读锁。

1. 在 Azure 门户中，导航到**az1000101b-RG**资源组边栏选项卡。

1. 从**az1000101b-RG**资源组边栏选项卡，导航到其**标记**边栏选项卡。

1. 从**标记**边栏选项卡，尝试将具有值**实验室**的**环境**标记分配给资源组，并记录错误消息。


> **结果**：完成此练习后，你已创建资源组级锁以防止意外更改并验证其功能。 

## 练习 3：移除实验室资源

#### 任务1：删除资源组级别锁。

1. 在 Azure 门户中，导航到**az1000101b-RG**资源组边栏选项卡。

1. 在 Azure 门户中，导航到**az1000101b-RG**资源组边栏选项卡。

1. 从**az1000101b-RG**资源组边栏选项卡，显示**az1000101b-RG-锁**边栏选项卡。

1. 在**az1000101b-RG - Locks** 边栏选项卡上，删除 **az1000101b-roLock**。

#### 任务2：删除策略分配和定义。

1. 在 Azure 门户中，导航到**政策**边栏选项卡。

1. 从**策略**边栏选项卡中导航到**策略-分配**边栏选项卡。 

1. 从**政策-分配**边栏选项卡中，删除在本实验室前面创建的分配。 

1. 从**策略**边栏选项卡中边栏选项卡导航到**策略-定义**边栏选项卡。 

1. 从**策略-定义**边栏选项卡中，删除先前在本实验室中创建的所有定义。 

#### 任务3：打开 Cloud Shell

1. 在门户顶部，单击**“Cloud Shell”**图标，打开 Cloud Shell 窗格。

1. 在 Cloud Shell 界面中，选择**“Bash”**。

1. 在 **Cloud Shell** 命令提示符处，键入以下命令并按 **Enter** 键列出你在本实验室中创建的所有资源组：

```sh
   az group list --query "[?starts_with(name,'az100010')].name" --output tsv
```

1. 验证输出中是否仅包含在本练习中创建的资源组。将在下一个任务中删除这些资源组。

#### 任务4：删除资源组

1. 在 **Cloud Shell** 命令提示符处，键入以下命令并按 **Enter** 键以删除你在本实验室中创建的资源组

```sh
   az group list --query "[?starts_with(name,'az100010')].name" --output tsv | xargs -L1 bash -c 'az group delete --name $0 --no-wait --yes'
```

1. 关闭门户底部的 **Cloud Shell** 提示。

> **结果**：在本练习中，将删除本实验室中使用的资源。
