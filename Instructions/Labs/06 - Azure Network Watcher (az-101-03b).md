---
lab:
    title: 'Azure 网络观察程序'
    module: '模块 06 - 监视'
---

# 实验：使用 Azure 网络观察程序监视网络连接并排除故障

本实验中的所有任务均在 Azure 门户中执行（包括 PowerShell Cloud Shell 会话）  

   > **注意**：不使用 Cloud Shell 时，实验室虚拟机必须安装 Azure PowerShell 1.2.0 模块（或更新版本）[https://docs.microsoft.com/zh-cn/powershell/azure/install-az-ps](https://docs.microsoft.com/zh-cn/powershell/azure/install-az-ps)

实验文件： 

-  **Labfiles\\Module_06\\Network_Watcher\\az-101-03b_01_azuredeploy.json**

-  **Labfiles\\Module_06\\Network_Watcher\\az-101-03b_02_azuredeploy.json**

-  **Labfiles\\Module_06\\Network_Watcher\\az-101-03b_01_azuredeploy.parameters.json**

-  **Labfiles\\Module_06\\Network_Watcher\\az-101-03b_02_azuredeploy.parameters.json**


### 场景
  
Adatum Corporation 希望使用 Azure 网络观察程序来监视 Azure 虚拟网络连接。


### 目标
  
完成本实验室后，你将能够：

-  使用 Azure 资源管理器模板部署 Azure VM、Azure 存储帐户和 Azure SQL 数据库实例

-  使用 Azure 网络观察程序监视网络连接


### 练习 1：准备基础结构以进行基于 Azure 网络观察程序的监视
  
本练习的主要任务如下：

1. 使用 Azure 资源管理器模板部署 Azure VM、Azure 存储帐户和 Azure SQL 数据库实例

1. 启用 Azure 网络观察程序服务

1. 在 Azure 虚拟网络之间建立对等互连

1. 建立至 Azure 存储帐户和 Azure SQL 数据库实例的服务终结点


#### 任务 1：使用 Azure 资源管理器模板部署 Azure VM、Azure 存储帐户和 Azure SQL 数据库实例

1. 在实验虚拟机中，启动 Microsoft Edge，导航到 Azure 门户 ([**http://portal.azure.com**](http://portal.azure.com))，并使用在目标 Azure 订阅中拥有所有者角色的 Microsoft 帐户登录。

1. 在 Azure 门户中，导航到 **创建资源** 边栏选项卡。

1. 从 **创建资源** 边栏选项卡，在 Azure Marketplace 搜索 **模板部署**。

1. 在结果列表中，单击**“模板部署(使用自定义模板部署)”**，再单击**“创建”**。

1. 在**“自定义部署”**边栏选项卡中，单击**“在编辑器中生成自己的模板”**链接。如果未看到此链接，请改为单击**“编辑模板”**。

1. 在**编辑模板**边栏选项卡上，加载模板文件 **az-101-03b_01_azuredeploy.json**。 

   > **备注**：查看模板内容，并注意其定义了 Azure VM、Azure SQL 数据库和 Azure 存储帐户的部署。

1. 保存模板并返回**“自定义部署”**边栏选项卡。 

1. 在**“自定义部署”**边栏选项卡中，导航到**“编辑参数”**边栏选项卡。

1. 在**编辑参数**边栏选项卡上，加载参数文件 **az-101-03b_01_azuredeploy.parameters.json**。 

1. 保存参数并返回到**自定义部署**边栏选项卡。 

1. 从**自定义部署**边栏选项卡，使用以下设置初始化模板部署：

    - 订阅：将在本实验中使用的订阅的名称

    - 资源组：新资源组 **az1010301b-RG** 的名称

    - 位置：最靠近实验位置的 Azure 区域的名称，可在其中预配 Azure VM 和 Azure SQL 数据库

    - VM 大小：**Standard_DS2_v2**

    - Vm名称：**az1010301b-vm1**

    - 管理员用户名：**学生**

    - 管理员密码：**Pa55w.rd1234**

    - 虚拟网络名称： **az1010301b-vnet1**

    - SQL 登录名：**学生**

    - SQL 登录密码：**Pa55w.rd1234**

    - 数据库名称：**az1010301b-db1**

    - SKU 名称：**基本**

    - SKU 层级：**基本**

   > **注意**：要确定订阅在指定区域中可用的 VM 大小，请在 Cloud Shell 中运行以下命令并查看**“限制”**列中的值（其中，&lt;location&gt; 表示目标 Azure 区域）：
   
```pwsh
   Get-AzComputeResourceSku | where {$_.Locations -icontains "<location>"} | Where-Object {($_.ResourceType -ilike "virtualMachines")}
```
   
   > **备注**：要确定是否可以在指定区域预配 Azure SQL 数据库，请在 Cloud Shell 中运行以下命令并确保生成的**“状态”**设置为**“可用”**（其中，&lt;location&gt; 表示目标 Azure 区域）：

```pwsh
   Get-AzSqlCapability -LocationName <regionname>
```
   
   > **备注**：无需等待部署完成，可直接继续执行下一个步骤。 

1. 在 Azure 门户中，导航到 **创建资源** 边栏选项卡。

1. 从 **创建资源** 边栏选项卡，在 Azure Marketplace 搜索 **模板部署**。

1. 在结果中，单击**“模板部署(使用自定义模板部署)”**，然后再单击**“创建”**。

1. 在**“自定义部署”**边栏选项卡中，单击**“在编辑器中生成自己的模板”**链接。如果未看到此链接，请改为单击**“编辑模板”**。

1. 在**编辑模板**边栏选项卡上，加载模板文件 **az-101-03b_02_azuredeploy.json**。 

   > **备注**：查看模板内容，并注意其定义了 Azure VM 的部署。

1. 保存模板并返回**“自定义部署”**边栏选项卡。 

1. 在**“自定义部署”**边栏选项卡中，导航到**“编辑参数”**边栏选项卡。

1. 在**“编辑参数”**边栏选项卡上，加载参数文件 **az-101-03b_02_azuredeploy.parameters.json**。 

1. 保存参数并返回**“自定义部署”**边栏选项卡。 

1. 从**自定义部署**边栏选项卡，使用以下设置初始化模板部署：

    - 订阅：你用于本实验室的订阅名称

    - 资源组：新资源组的名称 **az1010302b-RG**

    - 位置：Azure 区域的名称，可在其中预配 Azure Vm，但与在之前的部署中选择的区域**different**不同。 

    - Vm 大小：**Standard_DS2_v2**

    - Vm名称：**az1010302b-vm2**

    - 管理员用户名：**学生**

    - 管理员密码：**Pa55w.rd1234**

    - 虚拟网络名称： **az1010302b-vnet2**

   > **注意**：请确保为此部署选择不同的 Azure 区域

   > **注意**：无需等待部署完成，可直接继续执行下一个步骤。 


#### 任务 2：启用 Azure 网络观察程序服务

1. 在 Azure 门户中，使用**“所有服务”**边栏选项卡上的搜索文本框导航到**“网络观察程序”**边栏选项卡。

2. 在**“网络观察程序”**边栏选项卡上，验证在上一个任务中部署了资源的两个 Azure 区域中是否启用了网络观察程序，如果未启用，则将其启用。


#### 任务 3：在 Azure 虚拟网络之间建立对等互连

   > **注意**：开始本任务之前，请确保在本练习第一个任务中开始的模板部署已经完成。 

1. 在 Azure 门户中，导航到 **az1010301b-vnet1** 虚拟网络边栏选项卡。

1. 在 **az1010301b-vnet1** 虚拟网络边栏选项卡中，显示**“az1010301b-vnet1 - 对等互连”**边栏选项卡。

1. 在**“az1010301b-vnet1 - 对等互连”**边栏选项卡中，使用以下设置创建 VNet 对等互连：

    - 名称：**az1010301b-vnet1-to-az1010302b-vnet2**

    - 虚拟网络部署模型：**资源管理器**

    - 订阅：要用于本实验的 Azure 订阅的名称。

    - 虚拟网络：**az1010302b-vnet2**

    - 从 az1010302b-vnet2 到 az1010301b-vnet1 的对等互连名称：**az1010302b-vnet2-to-az1010301b-vnet1**

    - 允许虚拟网络访问：**启用**

    - 允许转发流量：**禁用**

    - 允许网关传输：禁用

    > **备注**：通过 Azure 门户，可以同时配置对等互连的两个方向。使用其他管理工具时，必须单独配置每个方向。 

#### 任务4：建立至 Azure 存储帐户和 Azure SQL 数据库实例的服务终结点

1. 在 Azure 门户中，导航到 **az1010301b-vnet1** 虚拟网络边栏选项卡。

1. 在 **az1010301b-vnet1** 虚拟网络边栏选项卡中，显示**“服务终结点”**边栏选项卡。

1. 在**“az1010301b-vnet1 - 服务终结点”**边栏选项卡中，添加具有以下设置的服务终结点：

    - 服务：**Microsoft.Storage**

    - 子网：**subnet0**

1. 重复此步骤以创建第二个服务终结点：

    - 服务：**Microsoft.Sql**

    - 子网：**subnet0**

1. 在 Azure 门户中，导航到 **az1010301b-RG** 资源组边栏选项卡。

1. 在 **az1010301b-RG** 资源组边栏选项卡，导航到资源组中包含的存储帐户的边栏选项卡。 

1. 在存储帐户边栏选项卡中，导航到其**“防火墙和虚拟网络”**边栏选项卡。

1. 在存储帐户的**“防火墙和虚拟网络”**边栏选项卡中，配置以下设置：

    - 允许从以下位置访问：**选定网络**

    - 虚拟网络： 

        - 虚拟网络：**az1010301b-vnet1**

            - 子网：**subnet0**

    - 防火墙： 

        - 地址范围：无

    - 例外项： 

        - 允许受信任的 Microsoft 服务访问此存储帐户：**启用**

        - 允许从任何网络对存储日志记录进行读取访问：**禁用**

        - 允许从任何网络对存储指标进行读取访问：**禁用**

1. 在 Azure 门户中，导航到 **az1010301b-RG** 资源组边栏选项卡。

1. 在 **az1010301b-RG** 资源组边栏选项卡中，导航到 **az1010301b** Azure SQL Server 边栏选项卡。 

1. 在 Azure SQL Server 边栏选项卡中，导航到其服务器的**“防火墙和虚拟网络”**边栏选项卡。

1. 在 Azure SQL 数据库服务器的**“防火墙和虚拟网络”**边栏选项卡中，配置以下设置：

    - 允许访问 Azure 服务：**打开**

    - 未配置防火墙规则 

    - 虚拟网络：

        - 名称：**az1010301b-vnet1**

        - 订阅：将在本实验中使用的订阅的名称

        - 虚拟网络：**az1010301b-vnet1**

        - 子网名称：**subnet0/ 10.203.0.0/24**

> **结果**：完成本练习后，你学会了如何使用 Azure 资源管理器模板部署 Azure VM、Azure 存储帐户和 Azure SQL 数据库实例；启用 Azure 网络观察程序服务；在 Azure 虚拟网络之间建立全球对等互连；建立至 Azure 存储帐户和 Azure SQL 数据库实例的服务终结点。


### 练习 2：使用 Azure 网络观察程序监视网络连接
  
本练习的主要任务如下：

1. 使用网络观察程序测试通过虚拟网络对等互连与 VM 建立的网络连接

1. 使用网络观察程序测试与 Azure 存储帐户建立的网络连接

1. 使用网络观察程序测试与 Azure SQL 数据库建立的网络连接


#### 任务 1：使用网络观察程序测试通过虚拟网络对等互连与 Azure VM 建立的网络连接

1. 在 Azure 门户中，导航到**“网络观察程序”**边栏选项卡。

1. 在**“网络观察程序”**边栏选项卡中，导航到**“连接故障排除”**。

1. 在**“网络观察程序 - 连接故障排除”**边栏选项卡中，使用以下设置启动检查：

    - 来源： 

        - 订阅：将在本实验中使用的 Azure 订阅的名称

        - 资源组：**az1010301b-RG**

        - 来源类型：**虚拟机**

        - 虚拟机：**az1010301b-vm1**

    - 目标：**手动指定**

        - URI、FQDN 或 IPv4：**10.203.16.4**

      > **注意**：**10.203.16.4** 是部署到另一个 Azure 区域的第二个 Azure VM az1010302b-vm1 的专用 IP 地址

    - 探测设置：

        - 协议：**TCP**

        - 目标端口：**3389**

    - 高级设置：

        - 来源端口：空白

1. 等到返回连接检查结果并验证状态是否为**“可访问”**。查看网络路径并注意连接是否为直连，VM 之间无中间跃点。

    > **注意**：首次使用网络观察程序时，最多可能需要 5 分钟才完成检查。


#### 任务 2：使用网络观察程序测试与 Azure 存储帐户建立的网络连接

1. 在 Azure 门户中，在 Cloud Shell 中启动 PowerShell 会话。 

   > **备注**：如果这是你第一次在当前 Azure 订阅中启动 Cloud Shell，则会要求你创建 Azure 文件共享以保留 Cloud Shell 文件。如果是，接受默认设置，这样会在自动生成的资源组中创建存储账户。

1. 在 Cloud Shell 窗格中，运行以下命令，确定在上一个练习中预配的 Azure 存储帐户的 blob 服务终结点的 IP 地址：

```pwsh
   [System.Net.Dns]::GetHostAddresses($(Get-AzStorageAccount -ResourceGroupName 'az1010301b-RG')[0].StorageAccountName + '.blob.core.windows.net').IPAddressToString
```

1. 记下生成的字符串，并在**“网络观察程序 - 连接故障排除”**边栏选项卡中，使用以下设置启动检查：

    - 来源： 

        - 订阅：将在本实验中使用的 Azure 订阅的名称

        - 资源组：**az1010301b-RG**

        - 来源类型：**虚拟机**

        - 虚拟机：**az1010301b-vm1**

    - 目标：**手动指定**

        - URI、FQDN 或 IPv4：在本任务上一个步骤中确定的存储帐户的 blob 服务终结点的 IP 地址

    - 探测设置：

        - 协议：**TCP**

        - 目标端口：**443**

    - 高级设置：

        - 来源端口：空白

1. 等到返回连接检查结果并验证状态是否为**“可访问”**。查看网络路径并注意连接是否为直连，VM 之间无中间跃点，且延迟很短。 

    > **注意**：与在上一个练习中创建的服务终结点建立连接。要验证这一点，请使用网络观察程序的**“下一跃点”**工具。

1. 在**“网络观察程序 - 连接故障排除”**边栏选项卡中，导航到**“网络观察程序 - 下一个跃点”**边栏选项卡并使用以下设置测试下一个跃点：

    - 订阅：将在本实验中使用的 Azure 订阅的名称

    - 资源组：**az1010301b-RG**

    - 虚拟机：**az1010301b-vm1**

    - 网络接口：**az1010301b-nic1**

    - 来源 IP 地址：**10.203.0.4**

    - 目标 IP 地址：本任务前面步骤中确定的存储帐户的 blob 服务终结点的 IP 地址

1. 验证结果是否将下一个跃点类型标识为 **VirtualNetworkServiceEndpoint**

1. 在**“网络观察程序 - 连接故障排除”**边栏选项卡中，使用以下设置启动检查：

    - 来源： 

        - 订阅：将在本实验中使用的 Azure 订阅的名称

        - 资源组：**az1010302b-RG**

        - 来源类型：**虚拟机**

        - 虚拟机：**az1010302b-vm2**

    - 目标：**手动指定**

        - URI、FQDN 或 IPv4：本任务前面步骤中确定的存储帐户的 blob 服务终结点的 IP 地址

    - 探测设置：

        - 协议：**TCP**

        - 目标端口：**443**

    - 高级设置：

        - 来源端口：空白

1. 等到返回连接检查结果并验证状态是否为**“可访问”**。 

    > **注意**：连接成功，但是，该连接是通过 Internet 建立的。要验证这一点，请再次使用网络观察程序的**“下一个跃点”**工具。

1. 在**“网络观察程序 - 连接故障排除”**边栏选项卡中，导航到**“网络观察程序 - 下一个跃点”**边栏选项卡并使用以下设置测试下一个跃点：

    - 订阅：将在本实验中使用的 Azure 订阅的名称

    - 资源组：**az1010302b-RG**

    - 虚拟机：**az1010302b-vm2**

    - 网络接口：**az1010302b-nic1**

    - 来源 IP 地址：**10.203.16.4**

    - 目标 IP 地址：本任务前面步骤中确定的存储帐户的 blob 服务终结点的 IP 地址

1. 验证结果是否将下一个跃点类型标识为 **Internet**


#### 任务 3：使用网络观察程序测试与 Azure SQL 数据库建立的网络连接

1. 在 Azure 门户中，在 Cloud Shell 中启动 PowerShell 会话。 

1. 在 Cloud Shell 窗格中，运行以下命令，确定在上一个练习中预配的 Azure SQL 数据库服务器的 IP 地址：

```pwsh
   [System.Net.Dns]::GetHostAddresses($(Get-AzSqlServer -ResourceGroupName 'az1010301b-RG')[0].FullyQualifiedDomainName).IPAddressToString
```

1. 记下生成的字符串，并在**“网络观察程序 - 连接故障排除”**边栏选项卡中，使用以下设置启动检查：

    - 来源： 

        - 订阅：将在本实验中使用的 Azure 订阅的名称

        - 资源组：**az1010301b-RG**

        - 来源类型：**虚拟机**

        - 虚拟机：**az1010301b-vm1**

    - 目标：**手动指定**

        - URI、FQDN 或 IPv4：本任务上一个步骤中确定的 Azure SQL 数据库服务器的 IP 地址

    - 探测设置：

        - 协议：**TCP**

        - 目标端口：**1433**

    - 高级设置：

        - 来源端口：空白

1. 等到返回连接检查结果并验证状态是否为**“可访问”**。查看网络路径并注意连接是否为直连，VM 之间无中间跃点，且延迟短。 

    > **注意**：与在上一个练习中创建的服务终结点建立连接。要验证这一点，请使用网络观察程序的**“下一跃点”**工具。

1. 在**“网络观察程序 - 连接故障排除”**边栏选项卡中，导航到**“网络观察程序 - 下一个跃点”**边栏选项卡并使用以下设置测试下一个跃点：

    - 订阅：将在本实验中使用的 Azure 订阅的名称

    - 资源组：**az1010301b-RG**

    - 虚拟机：**az1010301b-vm1**

    - 网络接口：**az1010301b-nic1**

    - 来源 IP 地址：**10.203.0.4**

    - 目标 IP 地址：本任务前面步骤中确定的 Azure SQL 数据库服务器的 IP 地址

1. 验证结果是否将下一个跃点类型标识为 **VirtualNetworkServiceEndpoint**

1. 在**“网络观察程序 - 连接故障排除”**边栏选项卡中，使用以下设置启动检查：

    - 来源： 

        - 订阅：将在本实验中使用的 Azure 订阅的名称

        - 资源组：**az1010302b-RG**

        - 来源类型：**虚拟机**

        - 虚拟机：**az1010302b-vm2**

    - 目标：**手动指定**

        - URI、FQDN 或 IPv4：本任务前面步骤中确定的 Azure SQL 数据库服务器的 IP 地址

    - 探测设置：

        - 协议：**TCP**

        - 目标端口：**1433**

    - 高级设置：

        - 来源端口：空白

1. 等到返回连接检查结果并验证状态是否为**“可访问”**。 

    > **注意**：连接成功，但是，该连接是通过 Internet 建立的。要验证这一点，请再次使用网络观察程序的**“下一个跃点”**工具。

1. 在**“网络观察程序 - 连接故障排除”**边栏选项卡中，导航到**“网络观察程序 - 下一个跃点”**边栏选项卡并使用以下设置测试下一个跃点：

    - 订阅：将在本实验中使用的 Azure 订阅的名称

    - 资源组：**az1010302b-RG**

    - 虚拟机：**az1010302b-vm2**

    - 网络接口：**az1010302b-nic1**

    - 来源 IP 地址：**10.203.16.4**

    - 目标 IP 地址：本任务前面步骤中确定的 Azure SQL 数据库服务器的 IP 地址

1. 验证结果是否将下一个跃点类型标识为 **Internet**


> **结果**：完成本练习后，你学会了如何使用 Azure 网络观察程序测试通过虚拟网络对等互连与 Azure VM 建立的网络连接、与 Azure 存储建立的网络连接，以及与 Azure SQL 数据库建立的网络连接。

## 练习 3：移除实验室资源

#### 任务1：打开 Cloud Shell

1. 在门户顶部，单击**“Cloud Shell”**图标，打开 Cloud Shell 窗格。

1. 在 Cloud Shell 界面中，选择**“Bash”**。

1. 在 **Cloud Shell** 命令提示符处，键入以下命令并按 **Enter** 键列出你在本实验室中创建的所有资源组：

```sh
   az group list --query "[?starts_with(name,'az1010')].name" --output tsv
```

1. 验证输出中是否仅包含在本练习中创建的资源组。将在下一个任务中删除这些资源组。

#### 任务2：删除资源组

1. 在 **Cloud Shell** 命令提示符处，键入以下命令并按 **Enter** 键以删除你在本实验室中创建的资源组

```sh
   az group list --query "[?starts_with(name,'az1010')].name" --output tsv | xargs -L1 bash -c 'az group delete --name $0 --no-wait --yes'
```

1. 关闭门户底部的 **Cloud Shell** 提示。

> **结果**：在本练习中，将删除本实验室中使用的资源。
